<font color=$spy.GetParam(gui.html.font_colour) size=$spy.GetParam(gui.html.font_size) face=$spy.GetParam(gui.html.font_name)>

<table border="0" VALIGN='center' style="border-collapse: collapse" width="100%" cellpadding="1" cellspacing="1" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)">

<tr VALIGN='center' ALIGN='left' NAME='SNUM_REFINEMENT_PROGRAM'>
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td width='50%' VALIGN='center' colspan=2>
    <b>Refinement Program</b>
  </td>
  <td VALIGN='center' colspan=2 align="right">
<!-- #include program gui\snippets\snippet-program.htm;scope=snum;prg_type=refinement;1; -->
  </td>
</tr>

<tr VALIGN='center' ALIGN='left' NAME='SNUM_REFINEMENT_METHOD'>
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td width='50%' align='left' colspan=2>
    <b>Refinement Method</b>
  </td>
  <td VALIGN='center' colspan='2' align="right">
    <font size='2'>

<!-- #include method gui\snippets\snippet-method.htm;scope=snum;prg_type=refinement;1; -->

    </font>
  </td>
</tr>

<tr VALIGN='center' ALIGN='left' NAME='SET_REFLECTIONS'>
  <td width='2' bgcolor='$spy.GetParam(gui.html.table_firstcol_colour)'></td>
  <td width='50%' VALIGN='center' colspan='2'>
    <b>%Reflection File%</b>
  </td>
  <td width='50%' VALIGN='center' ALIGN='right' colspan='2'>
    <font size='2'>
<!-- #include tool-footer gui\snippets\snippet-reflection-file.htm;1; -->
  </font>
</td>
</tr>

<tr VALIGN='center' ALIGN='left' NAME='SNUM_REFINEMENT_MAX_CYCLES'>
<td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td VALIGN='center' colspan=3>
    <b>Maximum Refinement Iterations</b>
  </td>
  <td VALIGN='center' ALIGN='right' colspan=1>
    <font size='2'>
      <input
        type='spin'
        width="50"
        height="$spy.GetParam(gui.html.spin_height)"
        bgcolor="spy.GetParam(gui.html.input_bg_colour)"
        name='SET_SNUM_REFINEMENT_MAX_CYCLES'
        value='$spy.GetParam(snum.refinement.max_cycles)'
        onchange="spy.SetMaxCycles(GetValue(SET_SNUM_REFINEMENT_MAX_CYCLES))"
      >
    </font>
  </td>
</tr>

<tr VALIGN='center' ALIGN='left' NAME='SNUM_REFINEMENT_MAX_PEAKS'>
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td VALIGN='center' colspan=3>
    <b>Number of Residual Peaks</b>
  </td>
  <td VALIGN='right' ALIGN='right' colspan=1>
    <font size='2'>
      <input
        type="spin"
        name="SET_SNUM_REFINEMENT_MAX_PEAKS"
        width="50"
        height="$spy.GetParam(gui.html.spin_height)"
        max='1000'
        bgcolor="spy.GetParam(gui.html.input_bg_colour)"
        value='$eval(abs\(spy.GetParam(snum.refinement.max_peaks)))'
        onchange='spy.SetMaxPeaks(GetValue(SET_SNUM_REFINEMENT_MAX_PEAKS))'
      >
    </font>
  </td>
</tr>

$spy.weightGuiDisplay()

<tr VALIGN='center' ALIGN='left' NAME='IGNORE_SETTINGS'>
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td VALIGN='center'  colspan=3>
    <b>
    <a href="
sel atoms where xatom.peak<$spy.GetParam(snum.refinement.auto.pruneQ)&&xatom.peak>0>>
kill sel>>
sel atoms where xatom.peak>$spy.GetParam(snum.refinement.auto.assignQ)>>
name sel C>>
sel -a>>
name sel 1 -c>>
sel atoms where xatom.uiso>$spy.GetParam(snum.refinement.auto.pruneU)>>
kill sel"
target = "Do automatic tidying once - tick the box to do it after every refinement"
>Autotidy
  </a>
  </b>
  <a
    href="spy.make_help_box -name='refinement-settings-h3-autotidy-settings' -popout='True'"
    target="Help me with this">
    <zimg border="0" src="info.png">
  </a>
</td>
<td VALIGN='center' ALIGN='right'  colspan=1>
  <font size='2'>
  <input
    type='checkbox'
    width="$spy.GetParam(gui.html.checkbox_height)"
    height="$spy.GetParam(gui.html.checkbox_height)"
    name='SNUM_REFINEMENT_AUTO_TIDY'
    checked="$spy.GetParam(snum.refinement.auto.tidy)"
    oncheck='spy.SetParam(snum.refinement.auto.tidy,True)'
    onuncheck='spy.SetParam(snum.refinement.auto.tidy,False)'
    value=''
  >
  </font>
</td>
</tr>


<!--
<tr VALIGN='center' ALIGN='left' NAME='IGNORE_SETTINGS'>
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td VALIGN='center'  colspan=3>
    <b>
      Graphical Output
    </b>
  </td>
  <td VALIGN='center' ALIGN='right'  colspan=1>
    <font size='2'>
      <input
        type='checkbox'
        width="$spy.GetParam(gui.html.checkbox_width)"
        height="$spy.GetParam(gui.html.checkbox_height)"
        fgcolor="$spy.GetParam(gui.html.font_colour)"
        bgcolor="$spy.GetParam(gui.html.table_bg_colour)"
        name='SNUM_REFINEMENT_GRAPHICAL_OUTPUT'
        checked="$spy.GetParam(snum.refinement.graphical_output)"
        oncheck='spy.SetParam(snum.refinement.graphical_output,true)'
        onuncheck='spy.SetParam(snum.refinement.graphical_output,false)>>spy.reset_file_in_OFS(refinement_image.htm)>>UpdateHtml'
        value=''
      >
    </font>
  </td>
</tr>
-->

<tr VALIGN="center" ALIGN="left" NAME="USE_SOLVENT_MASK">
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td VALIGN="center"  colspan=3>
    <b>
      Use solvent mask
    </b>
    <a
      href="spy.make_help_box -name='refinement-masks' -popout='True'"
      target="Help me with this">
      <zimg border="0" src="info.png">
    </a>
  </td>
  <td VALIGN="center" ALIGN="right"  colspan=1>
    <font size="2">
      <input
        type="checkbox"
        width="$spy.GetParam(gui.html.checkbox_width)"
        height="$spy.GetParam(gui.html.checkbox_height)"
        fgcolor="$spy.GetParam(gui.html.font_colour)"
        bgcolor="$spy.GetParam(gui.html.table_bg_colour)"
        name="SNUM_REFINEMENT_USE_SOLVENT_MASK"
        checked="$spy.GetParam(snum.refinement.use_solvent_mask)"
        oncheck="spy.SetParam(snum.refinement.use_solvent_mask,true)"
        onuncheck="
spy.SetParam(snum.refinement.use_solvent_mask,false)>>
if strcmp(spy.GetParam(snum.masks.original_hklsrc),'') then none else HKLSrc(spy.GetParam(snum.masks.original_hklsrc))>>
spy.SetParam(snum.masks.original_hklsrc,None)>>
UpdateHtml"
        value=""
      >
    </font>
  </td>
</tr>

<tr VALIGN="center" ALIGN="left" NAME="RECOMPUTE_MASK_BEFORE_REFINEMENT">
  <td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>
  <td VALIGN="center"  colspan=3>
    <b>
      Recompute mask before refinement
    </b>
  </td>
  <td VALIGN="center" ALIGN="right"  colspan=1>
    <font size="2">
      <input
        type="checkbox"
        width="$spy.GetParam(gui.html.checkbox_width)"
        height="$spy.GetParam(gui.html.checkbox_height)"
        fgcolor="$spy.GetParam(gui.html.font_colour)"
        bgcolor="$spy.GetParam(gui.html.table_bg_colour)"
        name="SNUM_REFINEMENT_RECOMPUTE_MASK_BEFORE_REFINEMENT"
        checked="$spy.GetParam(snum.refinement.recompute_mask_before_refinement)"
        oncheck="
spy.SetParam(snum.refinement.use_solvent_mask,true)>>
spy.SetParam(snum.refinement.recompute_mask_before_refinement,true)>>
UpdateHtml"
        onuncheck="spy.SetParam(snum.refinement.recompute_mask_before_refinement,false)"
        value=""
      >
    </font>
  </td>
</tr>

<!--<tr VALIGN='center' ALIGN='left' NAME='SNUM_REFINEMENT_UPDATE_WEIGHT'>-->
  <!--<td width="2" bgcolor="$spy.GetParam(gui.html.table_firstcol_colour)"></td>-->
    <!--<td VALIGN='center'  colspan=4>-->
      <!--<a href="spy.save_user_parameters(refinement)">-->
        <!--<b>Save these settings as user default</b>-->
      <!--</a>-->
    <!--</td>-->
<!--</tr>-->

<!-- #include refinement-settings-h3-autotidy gui\refinement-settings-h3-autotidy-settings.htm;gui\blocks\tool-h3-off.htm;image=refinement-settings-h3-autotidy-settings;colspan=4;onclick=;onclick=;2; -->

<!-- #includeif fs.Exists(refinement-settings-h3-refinement-settings-extra.htm) refinement-settings-h3-refinement-settings-extra refinement-settings-h3-refinement-settings-extra.htm;gui\blocks\tool-h3-off.htm;image=refinement-settings-h3-refinement-settings-extra;colspan=4;onclick=;onclick=;2; -->

<!-- #includeif fs.Exists(refinement_image.htm) refinement_image refinement_image.htm;1; -->

</table>
